---
title: "MSI quantification"
author: "Dr Matt Smith"
date: "3rd October 2023"
output: 
  html_document:
  toc: true
  #toc_depth: 2
  toc_float:
    smooth_scrol: true
    collapsed: true
geometry: margin=0.1in
---

# Load packages and custom functions

```{r, message=FALSE}
library(Cardinal)
library(dplyr)
library(chemCal)

#.libPaths()

# Set paths
base_path = "C:/Users/matsmi/OneDrive - Karolinska Institutet/Dokument/MSI/quant_MSImageR"
#base_path = "C:MSI/quant_MSImageR"
imzl_path = "C:/Users/matsmi/OneDrive - Karolinska Institutet/Dokument/MSI/quant_MSImageR/data" 
#imzl_path = "C:MSI/quant_MSImageR/data"
out_path = "C:/Users/matsmi/OneDrive - Karolinska Institutet/Dokument/MSI/quant_MSImageR/results"
#out_path = "C:MSI/quant_MSImageR/results"


source(sprintf("%s/R/functions.R", base_path))
```

# Read imzML files

Read data into cardinal and generate ion images.

```{r, message=FALSE}

cal_mix = Cardinal::readImzML(name = "2021_05_26_6_mix_dil_slide-01_02_50um_pos_1", 
                              folder = imzl_path)
tissue = Cardinal::readImzML(name = "2120_05_27_Cassettedosed_Liver_2Hrs_MRM01_1",
                             folder = imzl_path)

# Import mz_axes df (including IS info)
mz_df = read.csv(sprintf("%s/mz_axes.csv",out_path))
mz_df

```

## Set mz axes

### Calibration data
```{r, message=FALSE}

cal_matrix = as.matrix(spectra(cal_mix))
cal_matrix = rbind(cal_matrix,
                   matrix(ncol = ncol(cal_matrix),
                          nrow = nrow(mz_df) - nrow(cal_matrix)))

cal_mix = MSImagingExperiment(imageData=cal_matrix,
                           featureData=MassDataFrame(mz=mz_df$mz_name,
                                                     analyte = mz_df$analyte,
                                                     cal_mz = as.numeric(mz_df$cal_mzs)),
                           pixelData=pData(cal_mix))
```

### Tissue data
```{r, message=FALSE}
tissue_matrix = as.matrix(spectra(tissue))
tissue_matrix = rbind(tissue_matrix,
                   matrix(ncol = ncol(tissue_matrix),
                          nrow = nrow(mz_df) - nrow(tissue_matrix)))

tissue = MSImagingExperiment(imageData=tissue_matrix,
                           featureData=MassDataFrame(mz=mz_df$mz_name,
                                                     analyte = mz_df$analyte,
                                                     tissue_mz = as.numeric(mz_df$tissue_mzs)),
                           pixelData=pData(tissue))

```

# Set ROIs
Select ROIs in each sample.

## Select calibration spikes
```{r, message=FALSE, fig.align='center', fig.show='hold', out.width="49%",out.height="49%"}
# Set ROIs around calibration levels
cal_roi_df = read.csv(sprintf("%s/cal_rois.csv",out_path))

# Set cal levels
#cal1 <- selectROI(cal_mix, mz = mz(cal_mix)[1], contrast.enhance="histogram")
cal1 = cal_roi_df$cal1
#image(cal_mix, cal1~x*y, key=T)

#cal2 <- selectROI(cal_mix, mz = mz(cal_mix)[1], contrast.enhance="histogram")
cal2 = cal_roi_df$cal2
#image(cal_mix, cal2~x*y, key=T)

#cal3 <- selectROI(cal_mix, mz = mz(cal_mix)[1], contrast.enhance="histogram")
cal3 = cal_roi_df$cal3
#image(cal_mix, cal3~x*y, key=T)

#cal4 <- selectROI(cal_mix, mz = mz(cal_mix)[1], contrast.enhance="histogram")
cal4 = cal_roi_df$cal4
#image(cal_mix, cal4~x*y, key=T)

#cal5 <- selectROI(cal_mix, mz = mz(cal_mix)[2], contrast.enhance="histogram")
cal5 = cal_roi_df$cal5
#image(cal_mix, cal5~x*y, key=T)

#cal6 <- selectROI(cal_mix, mz = mz(cal_mix)[2], contrast.enhance="histogram")
cal6 = cal_roi_df$cal6
#image(cal_mix, cal6~x*y, key=T)

# Away from cal mix for standard addition - background
#cal7 <- selectROI(cal_mix, mz = mz(cal_mix)[1], contrast.enhance="histogram")
cal7 = cal_roi_df$cal7
#image(cal_mix, cal7~x*y, key=T)

cal_levels = makeFactor(L1 = cal1, L2 = cal2, L3 = cal3,
           L4 = cal4, L5 = cal5, L6 = cal6, L7 = cal7)

# Update pixel metadata
pData(cal_mix)$sample_type = "Cal"
pData(cal_mix)$replicate = "01"
pData(cal_mix)$ROI = cal_levels
pData(cal_mix)$sample_ID = sprintf("%s_rep%s_%s", pData(cal_mix)$sample_type, pData(cal_mix)$replicate, pData(cal_mix)$ROI)
pData(cal_mix)

# Image cal mix
image(cal_mix, mz = mz(cal_mix)[2], contrast.enhance="histogram")
image(cal_mix, cal_levels~x*y, key=T)

```


## Subset tissue
```{r, message=FALSE, fig.align='center', fig.show='hold', out.width="49%",out.height="49%"}
tissue_pixel_df = read.csv(sprintf("%s/tissue_pixels.csv",out_path))

image(tissue)

# Subset tissue pixels
#tissue_pixels = selectROI(tissue, contrast.enhance="histogram")
tissue_pixels = tissue_pixel_df$tissue_pixels
tissue = tissue[, tissue_pixels]

# Image tissue before and after subsetting
image(tissue, mz = mz(tissue)[1], contrast.enhance="histogram",
      superpose = FALSE, normalize.image = "linear")

```

### Select ROIs within tissue
```{r, message=FALSE, fig.align='center', fig.show='hold', out.width="49%",out.height="49%"}
tissue_roi_df = read.csv(sprintf("%s/tissue_rois.csv",out_path))

#tissue_roi1 <- selectROI(tissue, mz = mz(tissue)[2], contrast.enhance="histogram")
tissue_roi1 = tissue_roi_df$tissue_roi1
#image(tissue, tissue_roi1~x*y, key=T)

#tissue_roi2 <- selectROI(tissue, mz = mz(tissue)[2], contrast.enhance="histogram")
tissue_roi2 = tissue_roi_df$tissue_roi2
#image(tissue, tissue_roi2~x*y, key=T)

#tissue_roi3 <- selectROI(tissue, mz = mz(tissue)[2], contrast.enhance="histogram")
tissue_roi3 = tissue_roi_df$tissue_roi3
#image(tissue, tissue_roi3~x*y, key=T)

#tissue_roi4 <- selectROI(tissue, mz = mz(tissue)[2], contrast.enhance="histogram")
tissue_roi4 = tissue_roi_df$tissue_roi4
#image(tissue, tissue_roi4~x*y, key=T)

#tissue_roi5 <- selectROI(tissue, mz = mz(tissue)[2], contrast.enhance="histogram")
tissue_roi5 = tissue_roi_df$tissue_roi5
#image(tissue, tissue_roi5~x*y, key=T)

#tissue_roi6 <- selectROI(tissue, mz = mz(tissue)[2], contrast.enhance="histogram")
tissue_roi6 = tissue_roi_df$tissue_roi6
#image(tissue, tissue_roi6~x*y, key=T)

tissue_rois = makeFactor(roi1 = tissue_roi1, roi2 = tissue_roi2, roi3 = tissue_roi3,
                        roi4 = tissue_roi4, roi5 = tissue_roi5, roi6 = tissue_roi6)

# Update pixel metadata
pData(tissue)$sample_type = "Tissue"
pData(tissue)$replicate = "01"
pData(tissue)$ROI = tissue_rois
pData(tissue)$sample_ID = sprintf("%s_rep%s_%s", pData(tissue)$sample_type, pData(tissue)$replicate, pData(tissue)$ROI)
pData(tissue)

# Image
image(tissue, mz = mz(tissue)[1], contrast.enhance="histogram",
      superpose = FALSE, normalize.image = "linear")
image(tissue, tissue_rois~x*y, key=T)
```

# Normalise to internal standard (IS) if present

## Merge calibration and tissue data
```{r, message=FALSE}
# Set NA values to 0
cal_mix_NA = zero2na(MSIobject = cal_mix)
tissue_NA = zero2na(MSIobject = tissue)

# Combine data
msi_combined = cbind(cal_mix_NA, tissue_NA)

# Remove m/z values from experiment with no data
remove_inds = c()
for(mz_ind in 1:nrow(fData(msi_combined))){
  if(all(is.na(spectra(msi_combined)[mz_ind, ]))){
    remove_inds = c(remove_inds, mz_ind)
  }
}
msi_combined = msi_combined[-remove_inds, ]

```

## Normalise to IS
```{r, message=FALSE}

# Normalise intensity value to IS (if present)
msi_response = int2response(MSIobject = msi_combined)

#image(msi_response, mz = mz(msi_response)[1], subset=cal1)

```


# Quantify

## Calculate the mean response or intensity (per pixel) at each calibration level
```{r, message=FALSE}
# Average the response (response/pixel) for each calibration spot
response_per_pixel = summarise_cal_levels(MSIobject = msi_response,
                                     cal_label = "Cal")

response_per_pixel_calibration = response_per_pixel[[1]]
pixel_count_calibration = response_per_pixel[[2]]

```



## create calibration curves - ng/pixel

```{r, message=FALSE}
# Read in calibration metadata
cal_metadata = read.csv(sprintf("%s/calibration_metadata.csv",out_path)) %>%
  mutate(pixel_count = sapply(sample,
                        function(sample_name) pixel_count_calibration[[sample_name]]),
         ng_per_pixel = amount_ng / pixel_count)

cal_metadata


#Generate calibration curves using standard addition (to find background conc. and remove)
cal_list = create_cal_curve(response_matrix = response_per_pixel_calibration,
                            cal_metadata = cal_metadata,
                            cal_type = "std_addition")
cal_list
```


## Quantify tissue concentrations using calibration curves - ng/pixel across ROIs
```{r, message=FALSE}
# Quantify analyte conc. in tissue
tissue_concs = int2conc(MSIobject = msi_response,
                        cal_label = "Cal",
                        cal_list = cal_list)

image(tissue_concs, mz = mz(tissue_concs)[1], contrast.enhance="histogram",
      superpose = FALSE,  normalize.image = "none")

# Save progress
save.image(sprintf("%s/processed.RData", out_path))

```


# Statistical analysis

## Extract average conc. info
```{r, message=FALSE}
# Extract the average amount per pixel at each ROI in tissue
dfs <- createDatamatrix(MSIobject = tissue_concs)

conc_matrix = dfs[[1]]
sample_metadata = dfs[[2]]
feature_metadata = dfs[[3]]

conc_matrix
head(sample_metadata)

```

## Univariate stats

## Multivariate stats

# To do
Use S4 objects and methods for performance improvements.

R2 for cal curves

